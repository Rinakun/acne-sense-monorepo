<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>AcneSense - Reset Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      body,
      html {
        overscroll-behavior: none;
        -webkit-overflow-scrolling: touch;
        background-color: #d6ebd5;
        margin: 0;
        padding: 0;
        font-family: "poppins", sans-serif;
      }

      .header-title {
        font-family: "poppins", sans-serif;
        font-weight: 800;
        font-size: 20px;
      }
      .header-subtitle {
        font-family: "maven pro", sans-serif;
        font-size: 14px;
        font-weight: 500;
      }

      .title-font {
        font-family: "manrope", sans-serif;
        font-size: 48px;
        font-weight: 800;
      }
      .sub-title-font {
        font-family: "maven pro", sans-serif;
        font-size: 15px;
        font-weight: 500;
      }

      .password-toggle {
        cursor: pointer;
        color: #6b7280;
      }
      .password-toggle:hover {
        color: #40c057;
      }
    </style>
  </head>
  <body class="flex justify-center items-center min-h-screen p-0">
    <!-- Mobile version (small screens) -->
    <div class="block md:hidden w-full min-h-screen bg-white mx-auto flex flex-col relative overflow-hidden">
      <!-- Top curve background -->
      <div class="absolute top-0 left-0 w-full h-[150px] bg-gradient-to-b from-[#D6EBD5] to-white rounded-b-[50px] -z-10"></div>
      <div class="absolute top-[-80px] right-[-80px] w-[160px] h-[160px] bg-[#05FF05FF] rounded-full opacity-20 pointer-events-none"></div>
      <div class="absolute bottom-[-100px] left-[-130px] w-[200px] h-[200px] bg-[#03FF03FF] rounded-full opacity-15 pointer-events-none"></div>
      <div class="absolute top-[20%] left-[-40px] w-[80px] h-[80px] bg-[#00FF00FF] rounded-full opacity-10 pointer-events-none"></div>
      <div class="absolute top-[10%] right-[10px] w-[80px] h-[80px] bg-[#00FF00FF] rounded-full opacity-10 pointer-events-none"></div>
      
      <div class="text-center pt-10 pb-2">
        <div class="text-2xl font-extrabold text-black">
          Acne<span class="text-[#40c057]">Sense</span>
        </div>
        <div class="text-xs text-gray-500 mb-5">For Your Acne Solution</div>
      </div>

      <div class="text-center px-6">
        <h1 class="text-xl font-bold mb-2 header-title">Reset Password</h1>
        <h2 class="text-sm text-gray-600 mb-6 header-subtitle">Masukkan password baru untuk akun Anda</h2>
      </div>

      <div class="px-7 flex flex-col flex-grow">
        <form id="reset-form" class="flex flex-col flex-grow">
          <div class="mb-5">
            <label for="password" class="block mb-2 text-gray-800 font-medium text-[15px]">Password Baru</label>
            <div class="relative">
              <input id="password" type="password" placeholder="Masukkan password baru" required
                class="w-full px-3 py-3 pr-10 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#40c057]" />
              <i class="fas fa-eye password-toggle absolute right-3 top-1/2 transform -translate-y-1/2" onclick="togglePassword('password')"></i>
            </div>
          </div>

          <div class="mb-5">
            <label for="confirmPassword" class="block mb-2 text-gray-800 font-medium text-[15px]">Konfirmasi Password</label>
            <div class="relative">
              <input id="confirmPassword" type="password" placeholder="Konfirmasi password baru" required
                class="w-full px-3 py-3 pr-10 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#40c057]" />
              <i class="fas fa-eye password-toggle absolute right-3 top-1/2 transform -translate-y-1/2" onclick="togglePassword('confirmPassword')"></i>
            </div>
          </div>

          <button type="submit" class="w-full py-4 bg-[#546254] text-white rounded-xl font-semibold text-base hover:bg-[#43543d] transition-colors mt-4">
            Reset Password
          </button>
        </form>
      </div>

      <!-- Bottom curve background -->
      <div class="absolute bottom-0 left-0 w-full h-[150px] bg-gradient-to-t from-[#D6EBD5] to-white rounded-t-[50px] -z-10"></div>
    </div>

    <!-- Desktop / Tablet version (medium screens and up) -->
    <div class="hidden md:flex bg-[#D6EBD5] rounded-3xl shadow-xl overflow-hidden w-full max-w-[1100px] mx-auto">
      <!-- Left panel -->
      <div class="bg-white w-1/2 p-20 flex flex-col justify-center items-center rounded-l-3xl text-center">
        <h1 class="title-font mb-2 leading-6 select-none">
          Acne<span class="text-[#40c057]">Sense</span>
        </h1>
        <p class="sub-title-font leading-snug mb-12 select-none text-xl font-semibold">
          For Your Acne Solution
        </p>
        
        <h2 class="text-2xl font-bold mb-4">Reset Password</h2>
        <p class="text-gray-600 mb-8 px-10">Masukkan password baru untuk akun Anda</p>
        
        <form id="reset-form-desktop" class="w-full max-w-md space-y-6">
          <div class="flex flex-col text-left text-base">
            <label for="password-desktop" class="mb-3 text-black text-lg font-medium">Password Baru</label>
            <div class="relative">
              <input id="password-desktop" type="password" placeholder="Masukkan password baru" 
                class="border border-gray-400 rounded-lg px-5 py-4 pr-12 text-lg focus:outline-none focus:ring-2 focus:ring-[#40c057] w-full" required />
              <i class="fas fa-eye password-toggle absolute right-4 top-1/2 transform -translate-y-1/2 text-xl" onclick="togglePassword('password-desktop')"></i>
            </div>
          </div>

          <div class="flex flex-col text-left text-base">
            <label for="confirmPassword-desktop" class="mb-3 text-black text-lg font-medium">Konfirmasi Password</label>
            <div class="relative">
              <input id="confirmPassword-desktop" type="password" placeholder="Konfirmasi password baru" 
                class="border border-gray-400 rounded-lg px-5 py-4 pr-12 text-lg focus:outline-none focus:ring-2 focus:ring-[#40c057] w-full" required />
              <i class="fas fa-eye password-toggle absolute right-4 top-1/2 transform -translate-y-1/2 text-xl" onclick="togglePassword('confirmPassword-desktop')"></i>
            </div>
          </div>

          <button type="submit" class="w-full bg-[#546254] text-white py-3 rounded-lg hover:bg-[#43543d] transition-colors mt-6">
            Reset Password
          </button>
        </form>
      </div>

      <!-- Right panel -->
      <div class="w-1/2">
        <img src="/image/login.png" alt="Face with acne" class="h-full w-full object-cover" loading="lazy" style="min-height: 600px" />
      </div>
    </div>

    <!-- Status Messages -->
    <div id="message-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 hidden">
      <div id="status-message" class="px-6 py-3 rounded-lg shadow-lg text-white font-medium"></div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white p-6 rounded-lg text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#40c057] mx-auto mb-4"></div>
        <p class="text-gray-700">Mengatur ulang password...</p>
      </div>
    </div>

    <script>
      // Initialize Supabase client
      const supabase = window.supabase.createClient(
        '<%= process.env.SUPABASE_URL %>',
        '<%= process.env.SUPABASE_KEY %>'
      );

      // Toggle password visibility
      function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.nextElementSibling;
        
        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        } else {
          input.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        }
      }

      // Show status message
      function showMessage(message, isError = false) {
        const messageContainer = document.getElementById('message-container');
        const statusMessage = document.getElementById('status-message');
        
        statusMessage.textContent = message;
        statusMessage.className = `px-6 py-3 rounded-lg shadow-lg font-medium ${
          isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
        }`;
        
        messageContainer.classList.remove('hidden');
        
        setTimeout(() => {
          messageContainer.classList.add('hidden');
        }, 5000);
      }

      // Show/hide loading overlay
      function showLoading(show = true) {
        const overlay = document.getElementById('loading-overlay');
        if (show) {
          overlay.classList.remove('hidden');
        } else {
          overlay.classList.add('hidden');
        }
      }

      // Check if user came from password reset email
      async function checkPasswordResetToken() {
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');
        const type = hashParams.get('type');

        if (type === 'recovery' && accessToken) {
          try {
            const { data, error } = await supabase.auth.setSession({
              access_token: accessToken,
              refresh_token: refreshToken
            });

            if (error) {
              throw error;
            }

            showMessage('Token valid! Silakan masukkan password baru Anda.');
            return true;
          } catch (error) {
            console.error('Token verification error:', error);
            showMessage('Link reset password tidak valid atau sudah kedaluwarsa.', true);
            setTimeout(() => {
              window.location.href = '/forgot-password';
            }, 3000);
            return false;
          }
        } else {
          showMessage('Link reset password tidak valid.', true);
          setTimeout(() => {
            window.location.href = '/forgot-password';
          }, 3000);
          return false;
        }
      }

      // Handle form submission
      async function handleResetPassword(form) {
        const passwordInput = form.querySelector('input[type="password"]:first-of-type');
        const confirmPasswordInput = form.querySelector('input[type="password"]:last-of-type');
        const submitButton = form.querySelector('button[type="submit"]');
        
        const password = passwordInput.value.trim();
        const confirmPassword = confirmPasswordInput.value.trim();

        // Validation
        if (!password || !confirmPassword) {
          showMessage('Semua field harus diisi!', true);
          return;
        }

        if (password.length < 6) {
          showMessage('Password minimal 6 karakter!', true);
          return;
        }

        if (password !== confirmPassword) {
          showMessage('Password dan konfirmasi password tidak cocok!', true);
          return;
        }

        // Disable submit button and show loading
        const originalText = submitButton.textContent;
        submitButton.textContent = 'Mengatur ulang...';
        submitButton.disabled = true;
        showLoading(true);

        try {
          const { error } = await supabase.auth.updateUser({
            password: password
          });

          if (error) {
            throw error;
          }

          showMessage('Password berhasil diatur ulang! Anda akan dialihkan ke halaman login.');
          
          // Sign out and redirect to login
          await supabase.auth.signOut();
          
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);

        } catch (error) {
          console.error('Password reset error:', error);
          
          if (error.message.includes('New password should be different')) {
            showMessage('Password baru harus berbeda dari password lama!', true);
          } else if (error.message.includes('Password should be at least')) {
            showMessage('Password terlalu lemah. Gunakan password yang lebih kuat!', true);
          } else {
            showMessage('Gagal mengatur ulang password. Silakan coba lagi.', true);
          }
        } finally {
          showLoading(false);
          submitButton.textContent = originalText;
          submitButton.disabled = false;
        }
      }

      // Initialize page
      document.addEventListener('DOMContentLoaded', async function() {
        // Check if user came from valid reset link
        const isValidToken = await checkPasswordResetToken();
        
        if (!isValidToken) {
          return;
        }

        // Handle form submissions
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
          form.addEventListener('submit', async function(e) {
            e.preventDefault();
            await handleResetPassword(form);
          });
        });
      });
    </script>
  </body>
</html>
