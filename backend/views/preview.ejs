<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>AcneSense</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@700;800&family=Maven+Pro:wght@500&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet" />
    <link rel="manifest" href="/manifest.json" />
    
    <style>
        body,
        html {
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            margin: 0;
            padding: 0;
            font-family: "Manrope", sans-serif;
        }
        .header-font {
            font-family: "poppins", sans-serif;
            font-weight: 800;
            font-size: 24px;
        }
        .header-desktop-font {
            font-family: "poppins", sans-serif;
            font-weight: 600;
            font-size: 24px;
        }
        .title-font {
            font-weight: 800;
            font-size: 1.75rem; /* 28px approx */
            user-select: none;
        }
        .accent-green {
            color: #40c057;
        }
        .sub-title-font {
            font-family: "Maven Pro", sans-serif;
            font-weight: 500;
            font-size: 0.875rem; /* 14px */
            user-select: none;
        }
        .icon-style {
            font-size: 1.25rem;
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        /* Media queries for desktop styles */
        @media (min-width: 768px) {
            .desktop-container {
                max-height: 85vh;
                height: 85vh;
            }
            .desktop-right-panel {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            .desktop-right-content {
                flex: 1;
                overflow-y: auto;
                min-height: 0;
            }
            .desktop-left-panel {
                overflow-y: auto;
                max-height: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- Mobile Version -->
    <div class="block md:hidden h-screen bg-white relative flex flex-col">
        <header class="bg-[#E5F6E5] px-6 pt-6 pb-4 flex items-center justify-between">
            <div class="flex items-center">
                <button aria-label="Back" class="mr-5 text-black select-none" onclick="history.back()">
                    <i class="fa-solid fa-arrow-left" style="font-size: 24px; font-weight: 800; width: 20px"></i>
                </button>
                <h1 class="text-black header-font select-none">Preview</h1>
            </div>
        </header>

        <main class="flex-1 p-6 bg-white overflow-y-auto relative">
            <!-- Camera Preview -->
            <div class="rounded-lg mb-6 overflow-hidden">
                <img id="previewImage" src="" alt="Acne Preview" class="w-full h-auto rounded-lg object-cover" />
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-4">
                <button class="flex-1 bg-orange-400 text-white py-3 px-6 rounded-lg font-semibold hover:bg-orange-500 transition-colors"
                    onclick="window.location.href='/deteksi'">Foto Ulang</button>
                <button class="flex-1 bg-green-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-600 transition-colors"
                    onclick="startCheck()">Mulai Periksa</button>
            </div>
        </main>
    </div>

    <!-- Desktop Version -->
    <div class="hidden md:flex w-full h-screen mx-auto bg-[#D6EBD5] rounded-2xl overflow-hidden">
        <div class="flex flex-1 items-center justify-center" style="margin: 0 20px">
            <div class="bg-white w-full max-w-7xl rounded-2xl p-5 flex desktop-container">
                <!-- Left Panel -->
                <%- include('templates/menu-desktop.ejs'); %>

                <!-- Right Panel -->
                <div class="w-2/3 desktop-right-panel rounded-r-2xl overflow-hidden">
                    <header class="bg-[#6A9E61] p-6 flex items-center justify-between select-none flex-shrink-0">
                        <h2 class="header-desktop-font text-white">Preview</h2>
                        <a href="/profile">
                            <div class="w-12 h-12 rounded-full border border-gray-300 flex items-center justify-center overflow-hidden bg-white">
                                <img src="<%= user.foto_profile ? user.foto_profile : '/image/foto_profile/default.png' %>" alt="avatar"
                                    class="w-full h-full object-cover" />
                            </div>
                        </a>
                    </header>

                    <div class="desktop-right-content p-10 custom-scrollbar bg-gray-200 relative">
                        <div class="flex flex-col items-center">
                            <!-- Camera Preview -->
                            <div class="w-full max-w-md rounded-lg mb-8 overflow-hidden relative">
                                <img id="previewImageDesktop" src="" alt="Acne Preview" class="w-full h-auto rounded-lg object-cover" />
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex space-x-6 w-full max-w-md">
                                <button class="flex-1 bg-orange-400 text-white py-4 px-8 rounded-lg font-semibold hover:bg-orange-500 transition-colors text-lg"
                                    onclick="window.location.href='/deteksi'">Foto Ulang</button>
                                <button class="flex-1 bg-green-500 text-white py-4 px-8 rounded-lg font-semibold hover:bg-green-600 transition-colors text-lg"
                                    onclick="startCheck()">Mulai Periksa</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/scripts/pendaftaran-sw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Ambil gambar dari local storage
    const capturedImage = localStorage.getItem('capturedImage');

    // Jika ada gambar yang disimpan, tampilkan di preview
    if (capturedImage) {
        document.getElementById('previewImage').src = capturedImage;           // Untuk mobile
        document.getElementById('previewImageDesktop').src = capturedImage;   // Untuk desktop
    } else {
        // Jika tidak ada gambar, redirect ke halaman deteksi
        console.error('Tidak ada gambar yang tersedia di local storage. Redirecting to detection...');
        window.location.href = '/deteksi';
    }
});

async function startCheck() {
    // SweetAlert loading
    const loadingSwal = Swal.fire({
        title: 'Sedang memeriksa...',
        html: 'Mohon tunggu...',
        timer: 20000,
        timerProgressBar: true,
        didOpen: () => {
            Swal.showLoading();
        },
    });

    const capturedImage = localStorage.getItem('capturedImage');

    const userInfo = {
        age: <%= user.umur %>, // Angka
        skin_type: "<%= user.jenis_kulit %>", // String
        skin_tone: "<%= user.skin_tone %>" // String
    };

    console.log(`Data : \n${JSON.stringify(userInfo, null, 2)}\n`);

    try {
        const response = await fetch('http://localhost:5000/combined-diagnosis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image: capturedImage,
                user_info: userInfo
            })
        });

        const data = await response.json();
        Swal.close();

        // Cek jika tidak ada hasil deteksi jerawat
        if (data.detection_count === 0) {
            await Swal.fire({
                icon: 'info',
                title: 'Tidak ada jerawat terdeteksi',
                text: data.message,
                showCloseButton: true,
                confirmButtonText: 'Ok'
            });
            return; // Hentikan eksekusi lebih lanjut
        }

        // Jika ada hasil, teruskan ke proses selanjutnya
        const { classification_results, detection_classes } = data; // Mendapatkan classification_results dan detection_classes
        const detectionCount = data.detection_count;

        // Simpan hasil ke database sebelum redirect
        const saveResponse = await fetch('/save-detection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                detection_count: detectionCount,
                acne_types: data.acne_types, // Menambahkan acne_types asli ke body
                classification_results: classification_results, // Pastikan ini ditambahkan
                detection_classes: detection_classes, // Pastikan ini ditambahkan
                captured_image: capturedImage,
                recommendation: data.recommendation,
                detection_result: data.detection_result, // Menambahkan detection_result
                userId: <%= user.id_user %> // Mengirim ID user
            })
        });

        const saveData = await saveResponse.json();

        if (saveData.success) {
            // Setelah berhasil disimpan, redirect ke halaman hasil
            window.location.href = `/hasil/${saveData.id_riwayat}`; // Mengarahkan ke hasil dengan ID riwayat
        } else {
            await Swal.fire({
                icon: 'error',
                title: 'Gagal menyimpan data!',
                text: saveData.message,
                showCloseButton: true,
                confirmButtonText: 'Ok'
            });
        }

    } catch (error) {
        console.error('Error:', error);
        Swal.close();
        Swal.fire({
            icon: 'error',
            title: 'Terjadi kesalahan',
            text: 'Gagal melakukan pemeriksaan. Silakan coba lagi.'
        });
    }
}
</script>
</body>
</html>