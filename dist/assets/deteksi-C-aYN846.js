document.addEventListener("DOMContentLoaded",()=>{const c=document.getElementById("desktopCameraPreview"),m=document.getElementById("desktopCaptureButton"),p=document.getElementById("desktop-upload-input");let d=null;async function f(){d&&d.getTracks().forEach(e=>e.stop());try{const e={video:{facingMode:"environment",width:{ideal:1920,max:3840},height:{ideal:1080,max:2160}}};d=await navigator.mediaDevices.getUserMedia(e),c.srcObject=d,await new Promise(t=>{c.onloadedmetadata=()=>{c.play(),t()}})}catch(e){console.error("Error mengakses kamera:",e),alert("Tidak dapat mengakses kamera. Pastikan Anda memberikan izin.")}}function k(){if(!d){alert("Kamera belum siap");return}try{const e=document.createElement("canvas");e.width=c.videoWidth,e.height=c.videoHeight,e.getContext("2d").drawImage(c,0,0,e.width,e.height);const a=e.toDataURL("image/jpeg",.8);console.log("Desktop photo captured, size:",a.length),localStorage.setItem("capturedImage",a),window.location.href="/preview"}catch(e){console.error("Error capturing photo:",e),alert("Gagal mengambil foto. Silakan coba lagi.")}}function y(e){const t=e.target.files[0];if(!t)return;if(!t.type.startsWith("image/")){alert("Silakan pilih file gambar yang valid.");return}if(t.size>10*1024*1024){alert("Ukuran file terlalu besar. Maksimal 10MB.");return}const a=new FileReader;a.onload=g=>{try{const o=g.target.result;console.log("Desktop image uploaded, size:",o.length),localStorage.setItem("capturedImage",o),window.location.href="/preview"}catch(o){console.error("Error processing uploaded image:",o),alert("Gagal memproses gambar. Silakan coba lagi.")}},a.onerror=()=>{alert("Gagal membaca file gambar.")},a.readAsDataURL(t)}m&&m.addEventListener("click",k),p&&p.addEventListener("change",y),f();const n=document.getElementById("cameraPreview"),u=document.getElementById("captureButton"),i=document.getElementById("flashToggle"),h=document.getElementById("mobile-upload-input");let r=null,s=!1;async function b(){r&&r.getTracks().forEach(e=>e.stop());try{const e={video:{facingMode:"environment",width:{ideal:1920,max:3840},height:{ideal:1080,max:2160}}};r=await navigator.mediaDevices.getUserMedia(e),n.srcObject=r,await new Promise(t=>{n.onloadedmetadata=()=>{n.play(),t()}}),w()}catch(e){console.error("Error mengakses kamera:",e),alert("Tidak dapat mengakses kamera. Pastikan Anda memberikan izin.")}}function w(){if(!r)return;const t=r.getVideoTracks()[0].getCapabilities();t&&"torch"in t?(i.classList.remove("hidden"),i.disabled=!1):(i.classList.add("hidden"),i.disabled=!0)}async function v(){if(!r)return;const e=r.getVideoTracks()[0];try{s=!s,await e.applyConstraints({advanced:[{torch:s}]}),i.classList.toggle("text-yellow-500",s)}catch(t){console.warn("Gagal mengatur flash:",t),s=!s,alert("Tidak dapat mengaktifkan flash di perangkat ini.")}}function E(){if(!r){alert("Kamera belum siap");return}try{const e=document.createElement("canvas");e.width=n.videoWidth,e.height=n.videoHeight,e.getContext("2d").drawImage(n,0,0,e.width,e.height);const a=e.toDataURL("image/jpeg",.8);console.log("Mobile photo captured, size:",a.length),localStorage.setItem("capturedImage",a),window.location.href="/preview"}catch(e){console.error("Error capturing photo:",e),alert("Gagal mengambil foto. Silakan coba lagi.")}}function I(e){const t=e.target.files[0];if(!t)return;if(!t.type.startsWith("image/")){alert("Silakan pilih file gambar yang valid.");return}if(t.size>10*1024*1024){alert("Ukuran file terlalu besar. Maksimal 10MB.");return}const a=new FileReader;a.onload=g=>{try{const o=g.target.result;console.log("Mobile image uploaded, size:",o.length),localStorage.setItem("capturedImage",o),window.location.href="/preview"}catch(o){console.error("Error processing uploaded image:",o),alert("Gagal memproses gambar. Silakan coba lagi.")}},a.onerror=()=>{alert("Gagal membaca file gambar.")},a.readAsDataURL(t)}u&&u.addEventListener("click",E),i&&i.addEventListener("click",v),h&&h.addEventListener("change",I),b();const l=document.getElementById("focusCircle");n&&l&&n.addEventListener("click",async e=>{if(!r)return;const t=n.getBoundingClientRect(),a=e.clientX-t.left,g=e.clientY-t.top;l.style.left=`${a}px`,l.style.top=`${g}px`,l.style.transform="translate(-50%, -50%)",l.style.opacity="1";try{await r.getVideoTracks()[0].applyConstraints({advanced:[{focusMode:"manual",focusDistance:0}]}),setTimeout(()=>{l.style.opacity="0"},1e3)}catch(o){console.warn("Fokus manual tidak didukung:",o),setTimeout(()=>{l.style.opacity="0"},1e3)}})});
